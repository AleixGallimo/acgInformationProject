<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>评论测试页面</title>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css">
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <!-- 编辑器 -->
    <script src="asserts/plugins/wangEditor/wangEditor.js"></script>
    <!-- 本地 css 样式 -->
    <link href="asserts/css/commentStyle.css" rel="stylesheet">

    <script type="text/javascript">
        $(function () {
            //编辑窗口对象
            var editor;
            //当前用户权限
            var authority = 1;
            //当前文章id
            var articleId = 1;
            //当前用户id
            var userId = 1;

            //当前页数
            var thisPage = 1;
            //每页展示页数
            var pageSize = 5;
            //分页总页数
            var pageCount = 0;
            //评论总条数
            var commentCount = 0;

            var messageIndex;
            var messageArray = new Array();

            //评论方法
            var doAjax = function(){
                $(".newMessage").remove();
                $(".comment").remove();
                var offset = (thisPage - 1) * 5;
                $.ajax({
                    url:"/acgInformation/comment/getComment/" + offset + "/" + pageSize,
                    type:"GET",
                    data:{articleId:articleId},
                    sync:false,
                    success:function (data) {
                        if (data != null){
                            data = eval('(' + JSON.parse(data) + ')');
                            console.log(data);
                            for (var i in data) {
                                var comment = data[i];
                                var user = data[i].user;
                                var messages = data[i].messages;
                                console.log(messages == "");
                                var temp = "" +
                                    "<div class='comment container-fluid'>\n" +
                                    "    <div class='user col-lg-2'>\n" +
                                    "        <div class='userHead'>\n" +
                                    "            <img src='" + user.uPic + "' width='100' height='100' class='img-thumbnail'>\n" +
                                    "        </div>\n" +
                                    "        <div class='userName'>\n" +
                                    "            <div>" + user.uName +  "</div>\n" +
                                    "        </div>\n" +
                                    "    </div>\n" +
                                    "    <div class='content col-lg-10'>\n" +
                                    "        " + comment.cText + "\n" +
                                    "    </div>\n" +
                                    "    <div class='col-lg-2' style='height: 30px'></div>\n" +
                                    "    <div class='option col-lg-10'>\n" +
                                    "        <a href='#' class='replyComment'>回复</a> <a href='#' class='deleteComment'>删除</a>\n" +
                                    "    </div>\n" +
                                    "    <div class='messages col-lg-12'>\n" +
                                    "        <div class='col-lg-2' style='padding: 0'></div>\n" +
                                    "        <div class='message col-lg-10' style='border-left: #ebebeb solid 1px;'>\n" +
                                    "        </div>\n" +
                                    "    </div>\n" +
                                    "</div>"
                                    if (messages != ""){
                                        messageIndex = i;
                                        for (var j in messages){
                                            var message = "<div class='newMessage'><a href='#'>" + messages[j].user.uName + "</a>" + " : " + messages[j].mContent + " <a href='#' class='replyMessage'>回复</a> <a href='#' class='deleteMessage'>删除</a></div>";
                                            messageArray[j] = message;
                                        }
                                    }
                                $(".comments").append(temp);
                                if (messageArray != ""){
                                    var messageTemp = "";
                                    for (var k in messageArray){
                                        messageTemp = messageTemp + messageArray[k];
                                    }
                                    $(".message:eq(" + messageIndex + ")").html("<hr style='border: #dddddd solid 0.5px'>");
                                    $(".message:eq(" + messageIndex + ")").html(messageTemp);
                                    messageArray = new Array();
                                }
                            }
                            console.log(messageArray);
                            //加载分页数字
                            pages();
                            if (thisPage == 1){
                                $("#start_page").css("display","none");
                            } else {
                                $("#start_page").css("display","block");
                            }
                        } else {
                            alert("评论获取失败,网络异常");
                        }
                    }

                });
            }
            //分页数字方法
            var pages = function () {
                $(".page").remove();
                for (var i = 1;i <= pageCount;i++){
                    var item;
                    if (i == thisPage){
                        item = "<li class='page active'><a href='#pageHead' class='myPage'>" + i + "</a></li>";
                    } else {
                        item = "<li class='page'><a href='#pageHead' class='myPage'>" + i + "</a></li>";
                    }
                    $(".pages").append(item);
                }
                $(".myPage").each(function (i) {
                    $(this).click(function () {
                        if (i + 1 == thisPage){
                            return;
                        }
                        thisPage = $(this).text();
                        location.href = "#pageHead";
                        doAjax();
                    })
                })
            }
            //编辑框方法
            var wangEditor = function (){
                var E = window.wangEditor;
                editor = new E('#editor');
                //权限
                //工具栏权限判定
                if(authority == 1){
                    editor.customConfig.menus = ['head', 'bold', 'fontSize', 'fontName', 'italic', 'underline', 'strikeThrough', 'foreColor', 'backColor', 'list', 'justify', 'emoticon', 'image', 'code', 'undo', 'redo','qgs'];
                } else {
                    editor.customConfig.menus = ['emoticon', 'image', 'code', 'undo', 'redo', 'qgs'];
                }
                //表情框
                editor.customConfig.emotions = [
                    {
                        // tab 的标题
                        title: '默认',
                        // type -> 'emoji' / 'image'
                        type: 'image',
                        // content -> 数组
                        content : [{src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/7a/shenshou_thumb.gif", alt : "[草泥马]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/60/horse2_thumb.gif", alt : "[神马]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/bc/fuyun_thumb.gif", alt : "[浮云]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/c9/geili_thumb.gif", alt : "[给力]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/f2/wg_thumb.gif", alt : "[围观]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/70/vw_thumb.gif", alt : "[威武]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/6e/panda_thumb.gif", alt : "[熊猫]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/81/rabbit_thumb.gif", alt : "[兔子]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/bc/otm_thumb.gif", alt : "[奥特曼]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/15/j_thumb.gif", alt : "[囧]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/89/hufen_thumb.gif", alt : "[互粉]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/c4/liwu_thumb.gif", alt : "[礼物]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/ac/smilea_thumb.gif", alt : "[呵呵]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/0b/tootha_thumb.gif", alt : "[嘻嘻]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/6a/laugh.gif", alt : "[哈哈]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/14/tza_thumb.gif", alt : "[可爱]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/af/kl_thumb.gif", alt : "[可怜]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/a0/kbsa_thumb.gif", alt : "[挖鼻屎]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/f4/cj_thumb.gif", alt : "[吃惊]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/6e/shamea_thumb.gif", alt : "[害羞]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/c3/zy_thumb.gif", alt : "[挤眼]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/29/bz_thumb.gif", alt : "[闭嘴]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/71/bs2_thumb.gif", alt : "[鄙视]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/6d/lovea_thumb.gif", alt : "[爱你]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/9d/sada_thumb.gif", alt : "[泪]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/19/heia_thumb.gif", alt : "[偷笑]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/8f/qq_thumb.gif", alt : "[亲亲]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/b6/sb_thumb.gif", alt : "[生病]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/58/mb_thumb.gif", alt : "[太开心]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/17/ldln_thumb.gif", alt : "[懒得理你]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/98/yhh_thumb.gif", alt : "[右哼哼]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/6d/zhh_thumb.gif", alt : "[左哼哼]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/a6/x_thumb.gif", alt : "[嘘]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/af/cry.gif", alt : "[衰]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/73/wq_thumb.gif", alt : "[委屈]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/9e/t_thumb.gif", alt : "[吐]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/f3/k_thumb.gif", alt : "[打哈欠]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/27/bba_thumb.gif", alt : "[抱抱]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/7c/angrya_thumb.gif", alt : "[怒]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/5c/yw_thumb.gif", alt : "[疑问]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/a5/cza_thumb.gif", alt : "[馋嘴]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/70/88_thumb.gif", alt : "[拜拜]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/e9/sk_thumb.gif", alt : "[思考]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/24/sweata_thumb.gif", alt : "[汗]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/7f/sleepya_thumb.gif",}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/6b/sleepa_thumb.gif", alt : "[睡觉]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/90/money_thumb.gif", alt : "[钱]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/0c/sw_thumb.gif", alt : "[失望]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/40/cool_thumb.gif", alt : "[酷]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/8c/hsa_thumb.gif", alt : "[花心]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/49/hatea_thumb.gif", alt : "[哼]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/36/gza_thumb.gif", alt : "[鼓掌]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/d9/dizzya_thumb.gif", alt : "[晕]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/1a/bs_thumb.gif", alt : "[悲伤]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/62/crazya_thumb.gif", alt : "[抓狂]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/91/h_thumb.gif", alt : "[黑线]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/6d/yx_thumb.gif", alt : "[阴险]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/89/nm_thumb.gif", alt : "[怒骂]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/40/hearta_thumb.gif", alt : "[心]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/ea/unheart.gif", alt : "[伤心]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/58/pig.gif", alt : "[猪头]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/d6/ok_thumb.gif", alt : "[ok]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/d9/ye_thumb.gif", alt : "[耶]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/d8/good_thumb.gif", alt : "[good]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/c7/no_thumb.gif", alt : "[不要]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/d0/z2_thumb.gif", alt : "[赞]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/40/come_thumb.gif", alt : "[来]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/d8/sad_thumb.gif", alt : "[弱]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/91/lazu_thumb.gif", alt : "[蜡烛]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/6a/cake.gif", src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/d3/clock_thumb.gif", alt : "[钟]"}, {src : "http://img.t.sinajs.cn/t35/style/images/common/face/ext/normal/1b/m_thumb.gif", alt : "[话筒]"}]}]
                //创建编辑对象
                editor.create();
            }
            //评论总条数 & 分页总数方法
            var getPageCount = function () {
                $.ajax({
                    url:"/acgInformation/comment/all",
                    data:{articleId:articleId},
                    async:false,
                    success:function (data) {
                        commentCount = data;
                        pageCount = Math.ceil(commentCount / pageSize);
                    }});
                $(".commentCount").text(commentCount);
            }

            //判定第一次加载页面执行计算总评论条数方法
            if (commentCount == 0){
                getPageCount();
            }
            //加载评论
            doAjax();
            //加载编辑框
            wangEditor();

            //发表评论
            $("#btn").click(function () {
                var str = editor.txt.html();
                console.log(str);
                $.ajax({
                    url:"/acgInformation/comment/addComment",
                    type:"POST",
                    data:"{'cText':'" + str + "','cUid':'" + userId + "','cAid':'" + articleId + "'}",
                    contentType:"application/json;charset=UTF-8",
                    dataType:"JSON",
                    success:function (data) {
                        if (data != 0){
                            alert("评论发表成功!");
                            thisPage = pageCount;
                            doAjax();
                            pages();
                        }
                    }
                })
            })
        })
    </script>
</head>
<body>
    <div class="container">
        <div class="left col-lg-9">
            <!-- 文章模块 -->
            <div class="article">

                <div class="catalog col-lg-12">
                    首页 > 游戏
                </div>

                <div class="type col-lg-12">
                    <!-- Provides extra visual weight and identifies the primary action in a set of buttons -->
                    <button type="button" class="btn btn-primary">游戏</button>
                    <!-- Indicates a successful or positive action -->
                    <button type="button" class="btn btn-success">动漫</button>
                    <!-- Contextual button for informational alert messages -->
                    <button type="button" class="btn btn-info">二次元</button>
                    <!-- Indicates caution should be taken with this action -->
                    <button type="button" class="btn btn-warning">另类</button>
                    <!-- Indicates a dangerous or potentially negative action -->
                    <button type="button" class="btn btn-danger">十八禁</button>
                </div>

                <div class="title col-lg-12">
                    兽娘在线科普 萌妹花江夏树 A站一月新番挺有趣
                </div>

                <div class="logo col-lg-12">
                    <span class="ico glyphicon glyphicon-time"></span>2019-12-20
                    <span class="ico glyphicon glyphicon-eye-open"></span>67
                    <span class="ico glyphicon glyphicon-comment"></span><span class="commentCount">4</span>
                    <span class="ico glyphicon glyphicon-heart"></span>889
                </div>

                <hr style="border: #eeeeee solid 0.5px">

                <div class="articleContent">
                    <p><img src="https://www.menfuli.org/wp-content/uploads/2019/10/0006.jpg" alt="" width="800" height="1200" title="[神楽坂真冬] 恋人以上 英梨梨 [150P/481P] 神楽坂真冬 第1张-MEN"></p><p><br></p><p style="text-align: center;">[神楽坂真冬] 恋人以上 英梨梨 [150P/481P]</p><p style="text-align: center;"><br></p><p><img src="https://www.menfuli.org/wp-content/uploads/2019/10/0001.jpg" alt="" width="800" height="1200" title="[神楽坂真冬] Milk by blue 蕾姆 [150P/312M] 神楽坂真冬 第1张-MEN"></p><p style="text-align: center;"><br></p><p style="text-align: center;">[神楽坂真冬] Milk by blue 蕾姆 [150P/312M]</p><p style="text-align: center;"><br></p>
                </div>
            </div>
            <a href="#" name="pageHead"></a>
            <!-- 评论模块 -->
            <div class="comments"></div>
            <!-- 分页模块 -->
            <div class="other">
                <!--分页-->
                <div style="text-align: center">
                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                            <li>
                                <a href="#pageHead" aria-label="Previous" id="up">
                                    <span aria-hidden="true">上一页</span>
                                </a>
                            </li>
                        </ul>
                        <ul class="pages pagination"></ul>
                        <ul class="pagination">
                            <li>
                                <a href="#pageHead" aria-label="Next" id="down">
                                    <span aria-hidden="true">下一页</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>

                <div>
                    <div>
                        <div id="editor"></div>
                        <div class="col-lg-12" style="text-align: right;margin-top: 10px;padding: 0;"><input class="btn btn-default" type="button" value="发表评论" style="width: 150px;height: 50px;font-size: larger;" id="btn"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="right col-lg-3"></div>
    </div>
</body>
</html>